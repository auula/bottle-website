<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bottle Use Documentation</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Bottle Storage Engine Use Documentation.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="quick_start.html"><strong aria-hidden="true">2.</strong> QuickStart</a></li><li class="chapter-item expanded "><a href="basic_api.html"><strong aria-hidden="true">3.</strong> BasicAPI</a></li><li class="chapter-item expanded "><a href="data_encrypted.html"><strong aria-hidden="true">4.</strong> Encrypted</a></li><li class="chapter-item expanded "><a href="hashed_function.html"><strong aria-hidden="true">5.</strong> Hashed</a></li><li class="chapter-item expanded "><a href="indexes.html"><strong aria-hidden="true">6.</strong> Indexes</a></li><li class="chapter-item expanded "><a href="configure.html"><strong aria-hidden="true">7.</strong> Configure</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="programs.html"><strong aria-hidden="true">8.</strong> Programs</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="contributors.html"><strong aria-hidden="true">9.</strong> Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bottle Use Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/auula/bottle" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="what-is-bottle"><a class="header" href="#what-is-bottle">What is Bottleü§î?</a></h3>
<blockquote>
<p>üë®üèª‚Äçüíª: Bottle is a lightweight kv storage engine based on LSM-TREE.</p>
</blockquote>
<h3 id="project-introduction"><a class="header" href="#project-introduction">Project Introduction</a></h3>
<p>The first thing to note is that Bottle is a KV embedded storage engine, not a KV database. I know that many people see KV and think it is a database, but of course not. Many people will confuse these, KV storage can be used to store a lot of things, not the realm of databases. It can be understood that the database is a car, then the Bottle is the engine of a car. It can be simply understood that Bottle is an abstract KV encapsulation of the operating system file system. Based on Bottle as the storage layer, a database can be implemented by encapsulating some data structures and external service protocols on the Bottle layer.</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzfrmt7qo4j21c20u0tai.jpg" alt="hierarchy" /></p>
<blockquote>
<p>The function implementation of this project is completely based on the <a href="https://blog.ibyte.me/post/bitcask-kvbase/"><code>bitcask</code></a> paper. </p>
</blockquote>
<p>Interested friends can go and see this course. If you think it is good, you can give me a small star ‚≠ê Thank you.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="install-module"><a class="header" href="#install-module">Install ModuleüöÄ</a></h3>
<p>You just need to install the Bottle module in your project to use:</p>
<pre><code class="language-shell">go get -u github.com/auula/bottle
</code></pre>
<h3 id="bottle-source-code"><a class="header" href="#bottle-source-code">Bottle Source codeüå≤</a></h3>
<pre><code class="language-shell">.
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ bottle-logo.svg
‚îú‚îÄ‚îÄ bottle.go           # Main File
‚îú‚îÄ‚îÄ bottle_test.go      
‚îú‚îÄ‚îÄ encoding.go         # Data encoding module
‚îú‚îÄ‚îÄ encrypted.go        # Data encrypted module
‚îú‚îÄ‚îÄ encrypted_test.go
‚îú‚îÄ‚îÄ example             # Exmaple code
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ config.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ demo_exchange.go
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ demo_put_get.go
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ go.sum
‚îú‚îÄ‚îÄ gopher-bottle.svg
‚îú‚îÄ‚îÄ hashed.go          # Hashed function
‚îú‚îÄ‚îÄ item.go            # Data log Entry
‚îî‚îÄ‚îÄ option.go          # Bottle Configure 

1 directory, 17 files

</code></pre>
<h3 id="data-directory-"><a class="header" href="#data-directory-">Data Directory üìë</a></h3>
<p>Since the bottle design is based on a single-process program, each storage instance corresponds to a <code>data</code> directory, <code>data</code> is the log merge structure data directory, and <code>index</code> is the <code>index</code> data version.</p>
<p>Log consolving structural data The current version is merged every time the data is started. The default is that all data files under the DATA data folder occupies the total and more than <code>1GB</code> of more than <code>1GB</code> will trigger a merge, and the data that is not used after the merger is discarded.</p>
<p>Of course, if the dirty data merge requirements are not reached, the data file is archived in the size of the configured, each data has a version number, and is set to read-only mount, the process work directory structure is as follows:</p>
<pre><code class="language-shell">./testdata
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îî‚îÄ‚îÄ 1.data
‚îî‚îÄ‚îÄ index
    ‚îú‚îÄ‚îÄ 1646378326.index
    ‚îî‚îÄ‚îÄ 1646378328.index

2 directories, 3 files
</code></pre>
<p>When the storage engine starts working, the folder and files can only be operated by this process to ensure data security.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="basic-api-"><a class="header" href="#basic-api-">Basic API ‚öô</a></h3>
<p>Below is a usage example of a basic data manipulation I wrote:</p>
<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;github.com/auula/bottle&quot;
)

func init() {
	// Open a storage instance by default configuration
	err := bottle.Open(bottle.DefaultOption)
	// And handle possible errors
	if err != nil {
		panic(err)
	}
}

// Userinfo test data structure
type Userinfo struct {
	Name  string
	Age   uint8
	Skill []string
}

func main() {

	// PUT Data
	bottle.Put([]byte(&quot;foo&quot;), []byte(&quot;66.6&quot;))

	// If it is converted to string, it is a string
	fmt.Println(bottle.Get([]byte(&quot;foo&quot;)).String())

	// If there is no default, it is 0
	fmt.Println(bottle.Get([]byte(&quot;foo&quot;)).Int())

	// If it is not success, it is false.
	fmt.Println(bottle.Get([]byte(&quot;foo&quot;)).Bool())

	// If it is not success, it is 0.0
	fmt.Println(bottle.Get([]byte(&quot;foo&quot;)).Float())

	user := Userinfo{
		Name:  &quot;Leon Ding&quot;,
		Age:   22,
		Skill: []string{&quot;Java&quot;, &quot;Go&quot;, &quot;Rust&quot;},
	}

	var u Userinfo

	// Save the data object by BSON, and set the timeout for 5 seconds
    // TTL timeout can not set demand
	bottle.Put([]byte(&quot;user&quot;), bottle.Bson(&amp;user), bottle.TTL(5))

	// Analysis of structures by unwrap
	bottle.Get([]byte(&quot;user&quot;)).Unwrap(&amp;u)

	// Print value
	fmt.Println(u)

	// Remove key 'foo'
	bottle.Remove([]byte(&quot;foo&quot;))

	// Close handleable error that may happen
	if err := bottle.Close(); err != nil {
		fmt.Println(err)
	}
}
</code></pre>
<p>The following is a separate variable assignment and catch handling errors:</p>
<pre><code class="language-go">    data := bottle.Get([]byte(&quot;user&quot;))

	if data.IsError() {
		fmt.Println(data.Err)
	} else {
		fmt.Println(data.Value)
	}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="encryptor"><a class="header" href="#encryptor">Encryptorüîê</a></h3>
<p>The data <code>encryptor</code> records the value of the data, that is, the block encryption at the field level, instead of encrypting the entire file once, which will cause performance consumption, so the block data segment encryption method is adopted.</p>
<p>The following example uses the <a href="https://github.com/auula/bottle/blob/main/option.go#L66"><code>bottle.SetEncryptor(Encryptor,[]byte)</code></a> function to set the data encryptor and configure the 16-bit data encryption key.</p>
<pre><code class="language-go">func init() {
    bottle.SetEncryptor(bottle.AES(), []byte(&quot;1234567890123456&quot;))
}
</code></pre>
<p>You can also customize the interface to implement the data encryptor:</p>
<pre><code class="language-go">// SourceData for encryption and decryption
type SourceData struct {
    Data   []byte
    Secret []byte
}

// Encryptor used for data encryption and decryption operation
type Encryptor interface {
    Encode(sd *SourceData) error
    Decode(sd *SourceData) error
}
</code></pre>
<p>The following code is the implementation code of the built-in <code>AES</code> encryptor, just implement the <a href="https://github.com/auula/bottle/blob/main/encrypted.go#21"><code>bottle.Encryptor</code></a> interface, and the data source is the <a href="https://github.com/auula/bottle/blob/main/encrypted.go#15"><code>bottle.SourceData</code></a> structure field:</p>
<pre><code class="language-go">// AESEncryptor Implement the Encryptor interface
type AESEncryptor struct{}

// Encode source data encode
func (AESEncryptor) Encode(sd *SourceData) error {
    sd.Data = aesEncrypt(sd.Data, sd.Secret)
    return nil
}

// Decode source data decode
func (AESEncryptor) Decode(sd *SourceData) error {
    sd.Data = aesDecrypt(sd.Data, sd.Secret)
    return nil
}
</code></pre>
<p>The specific encryptor implementation code can be viewed in <a href="https://github.com/auula/bottle/blob/main/encrypted.go"><code>encrypted.go</code></a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="hashed-"><a class="header" href="#hashed-">Hashed üß∞</a></h3>
<p>If you need to customize the salad function, you can implement the <a href="https://github.com/auula/bottle/blob/main/hashed.go#10">bottle.Hashed</a> interface:</p>
<pre><code class="language-go">type Hashed interface {
    Sum64([]byte) uint64
}
</code></pre>
<p>Then complete your hash function configuration by built-in <a href="https://github.com/auula/bottle/blob/main/option.go#85"><code>bottle.SetHashFunc(hash Hashed)</code></a> settings.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="index-size-"><a class="header" href="#index-size-">Index Size üîé</a></h3>
<p>The index pre-set size will greatly affect your program acception and read data. If you can expect the index size required to run during initialization, and in initialization, you can decreaseThe performance issues that run data migration and expansion brought by the program during operation.</p>
<pre><code class="language-go">func init() {
    // setting indexes size
    bottle.SetIndexSize(1000)
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="configuration-information"><a class="header" href="#configuration-information">Configuration Information</a></h3>
<p>You can also use the default configuration, you can initialize your storage engine with the structure of the built-in <a href="https://github.com/auula/bottle/blob/main/option.go#14"><code>bottle.Option</code></a>, and the configuration instance is as follows:</p>
<pre><code class="language-go">func init() {
    // Custom configuration information
    option := bottle.Option{
        // Working directory
        Directory:       &quot;./data&quot;,
        // Algorithm opens encryption
        Enable:          true,
        // Customize the secret, you can use a built-in secret
        Secret:          bottle.Secret,
        // Custom data size, storage unit is KB
        DataFileMaxSize: 1048576,
    }
    // Custom configuration information
    bottle.Open(option)
}
</code></pre>
<p>Of course, you can also use the built-in <a href="https://github.com/auula/bottle/blob/main/bottle.go#157"><code>bottle.Load(path string)</code></a>  function to load the configuration file to start Bottle, the configuration file format is <code>YAML</code>, the configurable items are as follows:</p>
<pre><code class="language-go"># Bottle config options
Enable: TRUE
Secret: &quot;1234567890123456&quot;
Directory: &quot;./testdata&quot;
DataFileMaxSize: 536870912
</code></pre>
<p>It is important to note that the key implemented by the built-in encryptor must be <code>16</code> bits, if you are a custom implementation encrypler to set your custom encryprators through <a href="https://github.com/auula/bottle/blob/main/option.go#L66"><code>bottle.SetEncryptor(Encryptor,[]byte)</code></a>, then this secretThe number of digits will not be restricted.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="follow-up-maintenance-"><a class="header" href="#follow-up-maintenance-">Follow-up maintenance üéà</a></h3>
<ul>
<li>
<p><code>Bottle</code> does not currently support multi-data storage partitions, and subsequent versions will introduce a <code>Bucket</code> concept. In the future, the specified data can be stored in the specified partition to reduce the particle size of the lock when concurrent.</p>
</li>
<li>
<p>Subsequent <code>zero copy</code> technology, the current file operation is largely dependent on the operating system, and the current file must be <code>SYNC</code> to ensure data consistency.</p>
</li>
<li>
<p>Dirty data combination can be consolidated in operation, and the garbage collection work thread is notified based on the <code>signal</code>.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="vision-"><a class="header" href="#vision-">Vision üéâ</a></h3>
<p>If you have any questions about this project, you can contact me from the GitHub home page, you can also initiate a <code>pull request</code>, after your code is merged, you will appear in the following list~</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
